<!--
RSS generated by JIRA (7.6.3#76005-sha1:8a4e38d34af948780dbf52044e7aafb13a7cae58) at Mon Jan 21 19:19:32 UTC 2019

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<!-- If you wish to do custom client-side styling of RSS, uncomment this:
<?xml-stylesheet href="https://issues.apache.org/jira/styles/jiraxml2html.xsl" type="text/xsl"?>
-->
<rss version="0.92">
    <channel>
        <title>ASF JIRA</title>
        <link>https://issues.apache.org/jira/issues/?jql=project+%3D+AVRO+AND+created+%3E%3D+2013-11-26+AND+created+%3C%3D+2013-12-3+ORDER+BY+key+ASC</link>
        <description>An XML representation of a search request</description>
                <language>en-uk</language>
                        <issue start="0" end="1" total="1"/>
                <build-info>
            <version>7.6.3</version>
            <build-number>76005</build-number>
            <build-date>09-01-2018</build-date>
        </build-info>

<item>
            <title>[AVRO-1407] NettyTransceiver can cause a infinite loop when slow to connect</title>
                <link>https://issues.apache.org/jira/browse/AVRO-1407</link>
                <project id="12310911" key="AVRO">Apache Avro</project>
                    <description>&lt;p&gt;When a new &lt;tt&gt;NettyTransceiver&lt;/tt&gt; is created it forces the channel to be allocated and connected to the remote host. it waits for the connectTimeout ms on the &lt;a href=&quot;https://github.com/apache/avro/blob/1579ab1ac95731630af58fc303a07c9bf28541d6/lang/java/ipc/src/main/java/org/apache/avro/ipc/NettyTransceiver.java#L271&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;connect channel future&lt;/a&gt; this is obivously a good thing it&apos;s only that on being unsuccessful, ie &lt;tt&gt;!channelFuture.isSuccess()&lt;/tt&gt; an exception is thrown and the call to the constructor fails with an &lt;tt&gt;IOException&lt;/tt&gt;, but has the potential to leave a active channel associated with the &lt;tt&gt;ChannelFactory&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The problem is that a Netty &lt;tt&gt;NioClientSocketChannelFactory&lt;/tt&gt; will not shutdown if there are active channels still around and if you have supplied the &lt;tt&gt;ChannelFactory&lt;/tt&gt; to the &lt;tt&gt;NettyTransceiver&lt;/tt&gt; then  you will not be able to cancel it by calling &lt;tt&gt;ChannelFactory.releaseExternalResources()&lt;/tt&gt; like the &lt;a href=&quot;https://github.com/apache/flume/blob/b8cf789b8509b1e5be05dd0b0b16c5d9af9698ae/flume-ng-sdk/src/main/java/org/apache/flume/api/NettyAvroRpcClient.java#L158&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Flume Avro RPC client does&lt;/a&gt;. In order to recreate this you need a very laggy network, where the connect attempt takes longer than the connect timeout but does actually work, this very hard to organise in a test case, although I do have a test setup using vagrant VM&apos;s that recreates this everytime, using the Flume RPC client and server.&lt;/p&gt;

&lt;p&gt;The following stack is from a production system, it won&apos;t ever leave recover until the channel is disconnected (by forcing a disconnect at the remote host) or restarting the JVM.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Production stack trace&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;TLOG-0&quot; daemon prio=10 tid=0x00007f581c7be800 nid=0x39a1 waiting on condition [0x00007f57ef9f2000]
  java.lang.Thread.State: TIMED_WAITING (parking)
  at sun.misc.Unsafe.park(Native Method)
  parking to wait for &amp;lt;0x00000007218b16e0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
  at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:196)
  at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2025)
  at java.util.concurrent.ThreadPoolExecutor.awaitTermination(ThreadPoolExecutor.java:1253)
  at org.jboss.netty.util.internal.ExecutorUtil.terminate(ExecutorUtil.java:103)
  at org.jboss.netty.channel.socket.nio.AbstractNioWorkerPool.releaseExternalResources(AbstractNioWorkerPool.java:80)
  at org.jboss.netty.channel.socket.nio.NioClientSocketChannelFactory.releaseExternalResources(NioClientSocketChannelFactory.java:181)
  at org.apache.flume.api.NettyAvroRpcClient.connect(NettyAvroRpcClient.java:142)
  at org.apache.flume.api.NettyAvroRpcClient.connect(NettyAvroRpcClient.java:101)
  at org.apache.flume.api.NettyAvroRpcClient.configure(NettyAvroRpcClient.java:564)
  locked &amp;lt;0x00000006c30ae7b0&amp;gt; (a org.apache.flume.api.NettyAvroRpcClient)
  at org.apache.flume.api.RpcClientFactory.getInstance(RpcClientFactory.java:88)
  at org.apache.flume.api.LoadBalancingRpcClient.createClient(LoadBalancingRpcClient.java:214)
  at org.apache.flume.api.LoadBalancingRpcClient.getClient(LoadBalancingRpcClient.java:205)
  locked &amp;lt;0x00000006a97b18e8&amp;gt; (a org.apache.flume.api.LoadBalancingRpcClient)
  at org.apache.flume.api.LoadBalancingRpcClient.appendBatch(LoadBalancingRpcClient.java:95)
  at com.ean.platform.components.tlog.client.service.AvroRpcEventRouter$1.call(AvroRpcEventRouter.java:45)
  at com.ean.platform.components.tlog.client.service.AvroRpcEventRouter$1.call(AvroRpcEventRouter.java:43)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The solution is very simple, and a patch should be along in a moment.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12681865">AVRO-1407</key>
            <summary>NettyTransceiver can cause a infinite loop when slow to connect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gareth@logicalpractice.com">Gareth Davis</assignee>
                                    <reporter username="gareth@logicalpractice.com">Gareth Davis</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Nov 2013 11:00:40 +0000</created>
                <updated>Wed, 15 Nov 2017 12:26:14 +0000</updated>
                            <resolved>Wed, 26 Nov 2014 19:30:37 +0000</resolved>
                                    <version>1.7.5</version>
                    <version>1.7.6</version>
                                    <fixVersion>1.7.8</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>java</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                <comments>
                            <comment id="13835339" author="gareth@logicalpractice.com" created="Fri, 29 Nov 2013 12:27:51 +0000"  >&lt;p&gt;Patch attached.&lt;/p&gt;

&lt;p&gt;I&apos;m afraid I&apos;ve been unable to create a unit test, I&apos;m in the process of rewriting my test setup/rig to not require internal resources and be useful.&lt;/p&gt;</comment>
                            <comment id="13836970" author="frankgrimes97" created="Mon, 2 Dec 2013 21:58:42 +0000"  >&lt;p&gt;We were bitten by this many times with Flume OG.&lt;/p&gt;

&lt;p&gt;After many iterations of fixes to the NettyTransceiver code, we found it much easier and less buggy to simply use a Netty ChannelGroup to make sure that there are no race conditions between Channel connections and releaseExternalResources cleanup.&lt;/p&gt;

&lt;p&gt;FYI, in case you find it useful our patched code was as follows: &lt;br/&gt;
&lt;a href=&quot;https://github.com/frankgrimes97/flume/blob/418397479853f836d5845c4894f5a43e654628a9/flume-core/src/main/java/com/cloudera/flume/handlers/avro/AvroNettyTransceiver.java&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/frankgrimes97/flume/blob/418397479853f836d5845c4894f5a43e654628a9/flume-core/src/main/java/com/cloudera/flume/handlers/avro/AvroNettyTransceiver.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Cheers!&lt;/p&gt;</comment>
                            <comment id="13837516" author="gareth@logicalpractice.com" created="Tue, 3 Dec 2013 10:02:51 +0000"  >&lt;p&gt;Thanks.. I&apos;ve being having some similar thoughts and have started hacking away at &lt;a href=&quot;https://github.com/gid79/flume-async&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://github.com/gid79/flume-async&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ll being having a good look at the your Transceiver.&lt;/p&gt;</comment>
                            <comment id="13846905" author="cutting" created="Thu, 12 Dec 2013 23:23:58 +0000"  >&lt;p&gt;Why can&apos;t the channelFuture be closed in the finally clause?&lt;/p&gt;</comment>
                            <comment id="14140754" author="gareth@logicalpractice.com" created="Fri, 19 Sep 2014 15:43:31 +0000"  >&lt;p&gt;10 months to respond doesn&apos;t seem too bad.... sorry.&lt;/p&gt;

&lt;p&gt;The channel only needs to be closed only on an exception, hence the catch Throwable.  The core problem is that the constructor is allocating resources that can&apos;t aren&apos;t reachable if the constructor fails.&lt;/p&gt;</comment>
                            <comment id="14216670" author="cutting" created="Tue, 18 Nov 2014 19:43:40 +0000"  >&lt;p&gt;Is it possible to add a unit test for this?&lt;/p&gt;</comment>
                            <comment id="14216682" author="gareth@logicalpractice.com" created="Tue, 18 Nov 2014 19:52:28 +0000"  >&lt;p&gt;I&apos;ll have a bash now, from memory it was rather hard to recreate&lt;/p&gt;</comment>
                            <comment id="14216739" author="gareth@logicalpractice.com" created="Tue, 18 Nov 2014 20:26:59 +0000"  >&lt;p&gt;test case that demonstrates the issue.&lt;/p&gt;

&lt;p&gt;Applying this shows the issue. It can be made to show it really clearly if you comment out the serverSocket.close() as the failing test will never terminate.&lt;/p&gt;

&lt;p&gt;applying the actual code patch fixes the test.&lt;/p&gt;</comment>
                            <comment id="14216745" author="gareth@logicalpractice.com" created="Tue, 18 Nov 2014 20:28:12 +0000"  >&lt;p&gt;replacement for &lt;a href=&quot;https://issues.apache.org/jira/browse/AVRO-1407&quot; title=&quot;NettyTransceiver can cause a infinite loop when slow to connect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AVRO-1407&quot;&gt;&lt;del&gt;AVRO-1407&lt;/del&gt;&lt;/a&gt;-1.patch which doesn&apos;t duplicate a one of the debug statements&lt;/p&gt;</comment>
                            <comment id="14216749" author="gareth@logicalpractice.com" created="Tue, 18 Nov 2014 20:30:36 +0000"  >&lt;p&gt;I haven&apos;t gone nuts with the test in that it only verifies the main failure case... it doesn&apos;t verify that none connect failures are propagated correctly.&lt;/p&gt;</comment>
                            <comment id="14226684" author="jira-bot" created="Wed, 26 Nov 2014 19:30:22 +0000"  >&lt;p&gt;Commit 1641894 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cutting&quot; class=&quot;user-hover&quot; rel=&quot;cutting&quot;&gt;Doug Cutting&lt;/a&gt; in branch &apos;avro/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1641894&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/r1641894&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AVRO-1407&quot; title=&quot;NettyTransceiver can cause a infinite loop when slow to connect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AVRO-1407&quot;&gt;&lt;del&gt;AVRO-1407&lt;/del&gt;&lt;/a&gt;: Java: Fix infinite loop on slow connect in NettyTransceiver.  Contributed by Gareth Davis.&lt;/p&gt;</comment>
                            <comment id="14226685" author="cutting" created="Wed, 26 Nov 2014 19:30:37 +0000"  >&lt;p&gt;I committed this.  Thanks, Gareth!&lt;/p&gt;</comment>
                            <comment id="14226804" author="hudson" created="Wed, 26 Nov 2014 20:55:16 +0000"  >&lt;p&gt;SUCCESS: Integrated in AvroJava #502 (See &lt;a href=&quot;https://builds.apache.org/job/AvroJava/502/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://builds.apache.org/job/AvroJava/502/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/AVRO-1407&quot; title=&quot;NettyTransceiver can cause a infinite loop when slow to connect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AVRO-1407&quot;&gt;&lt;del&gt;AVRO-1407&lt;/del&gt;&lt;/a&gt;: Java: Fix infinite loop on slow connect in NettyTransceiver.  Contributed by Gareth Davis. (cutting: rev 1641894)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/avro/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/avro/trunk/lang/java/ipc/src/main/java/org/apache/avro/ipc/NettyTransceiver.java&lt;/li&gt;
	&lt;li&gt;/avro/trunk/lang/java/ipc/src/test/java/org/apache/avro/ipc/NettyTransceiverWhenFailsToConnect.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16217204" author="nkollar" created="Tue, 24 Oct 2017 16:39:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sacharya&quot; class=&quot;user-hover&quot; rel=&quot;sacharya&quot;&gt;Suraj Acharya&lt;/a&gt; it seems this is an old bugfix, the fix looks compatible with 1.7 branch, and the fix version is 1.7.8. Should this also be backported to brach-1.7?&lt;/p&gt;</comment>
                            <comment id="16250648" author="sacharya" created="Tue, 14 Nov 2017 01:41:51 +0000"  >&lt;p&gt;Yes.&lt;br/&gt;
Feel free to cherry-pick it back to 1.7.8.&lt;br/&gt;
I am for the time being removing the release version 1.7.8 from the Jira&lt;/p&gt;</comment>
                            <comment id="16253362" author="jira-bot" created="Wed, 15 Nov 2017 12:24:56 +0000"  >&lt;p&gt;Commit 40733f9ab971c7f3fa26bb6c1a2f6dbf88b2a612 in avro&apos;s branch refs/heads/branch-1.7 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cutting&quot; class=&quot;user-hover&quot; rel=&quot;cutting&quot;&gt;Doug Cutting&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=avro.git;h=40733f9&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=avro.git;h=40733f9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AVRO-1407&quot; title=&quot;NettyTransceiver can cause a infinite loop when slow to connect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AVRO-1407&quot;&gt;&lt;del&gt;AVRO-1407&lt;/del&gt;&lt;/a&gt;: Java: Fix infinite loop on slow connect in NettyTransceiver.  Contributed by Gareth Davis.&lt;/p&gt;

&lt;p&gt;git-svn-id: &lt;a href=&quot;https://svn.apache.org/repos/asf/avro/trunk@1641894&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://svn.apache.org/repos/asf/avro/trunk@1641894&lt;/a&gt; 13f79535-47bb-0310-9956-ffa450edef68&lt;br/&gt;
(cherry picked from commit fbaf3c399e2f34e57008d8625c76f0543a3cadf4)&lt;/p&gt;</comment>
                            <comment id="16253367" author="nkollar" created="Wed, 15 Nov 2017 12:26:02 +0000"  >&lt;p&gt;Thanks Suraj, backported to branch-1.7&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12616375" name="AVRO-1407-1.patch" size="1389" author="gareth@logicalpractice.com" created="Fri, 29 Nov 2013 12:27:51 +0000"/>
                            <attachment id="12682230" name="AVRO-1407-2.patch" size="984" author="gareth@logicalpractice.com" created="Tue, 18 Nov 2014 20:28:12 +0000"/>
                            <attachment id="12682229" name="AVRO-1407-testcase.patch" size="2811" author="gareth@logicalpractice.com" created="Tue, 18 Nov 2014 20:26:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 2 Dec 2013 21:58:42 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>361129</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 9 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1q933:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>361428</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>
