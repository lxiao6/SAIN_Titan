<!--
RSS generated by JIRA (7.6.3#76005-sha1:8a4e38d34af948780dbf52044e7aafb13a7cae58) at Mon Jan 21 19:17:12 UTC 2019

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<!-- If you wish to do custom client-side styling of RSS, uncomment this:
<?xml-stylesheet href="https://issues.apache.org/jira/styles/jiraxml2html.xsl" type="text/xsl"?>
-->
<rss version="0.92">
    <channel>
        <title>ASF JIRA</title>
        <link>https://issues.apache.org/jira/issues/?jql=project+%3D+AVRO+AND+created+%3E%3D+2012-5-23+AND+created+%3C%3D+2012-5-28+ORDER+BY+key+ASC</link>
        <description>An XML representation of a search request</description>
                <language>en-uk</language>
                        <issue start="0" end="3" total="3"/>
                <build-info>
            <version>7.6.3</version>
            <build-number>76005</build-number>
            <build-date>09-01-2018</build-date>
        </build-info>

<item>
            <title>[AVRO-1101] avro-c: reference counting error in avro_schema_record_field_get() and friends</title>
                <link>https://issues.apache.org/jira/browse/AVRO-1101</link>
                <project id="12310911" key="AVRO">Apache Avro</project>
                    <description>&lt;p&gt;There is a couple of reference counting errors in avro-c which can produce crash bugs. Attached example shows this problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12557446">AVRO-1101</key>
            <summary>avro-c: reference counting error in avro_schema_record_field_get() and friends</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mpugachev">Pugachev Maxim</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 May 2012 14:19:46 +0000</created>
                <updated>Tue, 25 Sep 2012 21:22:59 +0000</updated>
                            <resolved>Thu, 13 Sep 2012 21:17:41 +0000</resolved>
                                    <version>1.6.3</version>
                    <version>1.7.0</version>
                                                    <component>c</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                <comments>
                            <comment id="13282514" author="mpugachev" created="Thu, 24 May 2012 14:21:04 +0000"  >&lt;p&gt;Example.&lt;/p&gt;</comment>
                            <comment id="13282515" author="mpugachev" created="Thu, 24 May 2012 14:21:28 +0000"  >&lt;p&gt;Patch for this issue.&lt;/p&gt;</comment>
                            <comment id="13284341" author="mpugachev" created="Mon, 28 May 2012 09:20:55 +0000"  >&lt;p&gt;The problem is wider than I think. So, I`ve updated a patch.&lt;/p&gt;</comment>
                            <comment id="13284342" author="mpugachev" created="Mon, 28 May 2012 09:21:26 +0000"  >&lt;p&gt;Updated patch.&lt;/p&gt;</comment>
                            <comment id="13291158" author="dcreager" created="Thu, 7 Jun 2012 17:48:14 +0000"  >&lt;p&gt;It&apos;s not well-documented, but I think the intention with those accessor functions is that you borrow the reference from the parent schema.  That way if you loop through the fields in a record schema, you don&apos;t have to call avro_schema_decref on each field.  You&apos;ve got a valid reference to the record, and the record has references to its fields, so you know the fields will be valid for however long you&apos;re working with the record.&lt;/p&gt;

&lt;p&gt;If you want to save a reference to the field somewhere else, though, then it&apos;s your responsibility to call avro_schema_incref on the field before you stash it away.&lt;/p&gt;

&lt;p&gt;I think this reference counting schema was modeled after the Jansson library; there&apos;s a good overview of the borrowed reference idea in &lt;a href=&quot;http://www.digip.org/jansson/doc/2.3/apiref.html#reference-count&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;their documentation&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;So based on all of this, I think a better patch is to document that these accessor functions return a borrowed reference.&lt;/p&gt;</comment>
                            <comment id="13291582" author="mpugachev" created="Fri, 8 Jun 2012 07:02:37 +0000"  >&lt;p&gt;For me an idea that some library functions returns a schema with incremented counter and some are not seems not so obvious. In this scenario I must constantly consult the documentation about these rules and keep in mind internal structure of the library. I think that the perfectly clear solution is the condition that I &lt;em&gt;always&lt;/em&gt; get incremented reference counter from any function I called, so I &lt;em&gt;always&lt;/em&gt; should decrement it afterwards.&lt;/p&gt;</comment>
                            <comment id="13393691" author="mpugachev" created="Mon, 18 Jun 2012 06:46:07 +0000"  >&lt;p&gt;Guys, do you have any objections to this issue?&lt;/p&gt;</comment>
                            <comment id="13396258" author="dcreager" created="Mon, 18 Jun 2012 21:15:54 +0000"  >&lt;p&gt;I still disagree with this patch, but haven&apos;t closed it yet because I want to hear from some other C contributors.&lt;/p&gt;

&lt;p&gt;I think that the current solution is better.  If you call a function that creates a new schema, you have a reference that you have to decrement.  If you call a function that returns a subschema of a schema that already exists, then you don&apos;t get a new reference automatically.  That lets you write a loop very simply:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;avro_schema_t  rec_schema = &lt;span class=&quot;code-comment&quot;&gt;/* from somewhere */&lt;/span&gt;;
size_t  count = avro_schema_record_size(rec_schema);
size_t  i;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (i = 0; i &amp;lt; count; i++) {
    avro_schema_t  field_schema =
        avro_schema_record_get_by_index(rec_schema, i);
    printf(&lt;span class=&quot;code-quote&quot;&gt;&quot;%zu: %s\n&quot;&lt;/span&gt;, i, avro_schema_type_name(field_schema));
    &lt;span class=&quot;code-comment&quot;&gt;/* don&apos;t have to decref field_schema */&lt;/span&gt;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That missing decref isn&apos;t much in this simple example, but internally there are a couple of places where we have to iterate through all of the subschemas when we process a value &#8212; avro_value_copy and avro_value_write, for instance.  If you call avro_value_write on millions of values, and your schema has 10-20 fields, that&apos;s just saved you 10-20 million (atomic) increments and decrements.  Those can add up.&lt;/p&gt;</comment>
                            <comment id="13396553" author="lmartinking" created="Tue, 19 Jun 2012 06:41:43 +0000"  >&lt;p&gt;My colleague (Michael Cooper) and I have contributed some code to the Avro-C libraries.&lt;/p&gt;

&lt;p&gt;We would prefer the current method, (which seems to be more efficient), as we are reading and writing huge amounts of data with Avro. We often encounter segfaults by our own making during &lt;b&gt;testing&lt;/b&gt; but these are definitely worth the performance benefits.&lt;/p&gt;

&lt;p&gt;For example, in the case of reading we currently use Avro roughly as follows:&lt;/p&gt;

&lt;p&gt;&amp;lt;create the interface from the reader schema&amp;gt;&lt;br/&gt;
&amp;lt;create a generic value from the interface&amp;gt;&lt;br/&gt;
&amp;lt;load the field indexes from the generic value&amp;gt;&lt;br/&gt;
&amp;lt;decref the generic value&amp;gt;&lt;/p&gt;

&lt;p&gt;Then for each Avro record in a data file:&lt;/p&gt;

&lt;p&gt;&amp;lt;read the record value&amp;gt;&lt;br/&gt;
&amp;lt;read each field by index&amp;gt;&lt;br/&gt;
&amp;lt;reset the value&amp;gt;&lt;/p&gt;

&lt;p&gt;And in the case of writing:&lt;/p&gt;

&lt;p&gt;&amp;lt;create the avro schema from json&amp;gt;&lt;br/&gt;
&amp;lt;open file writer with schema and codec&amp;gt;&lt;br/&gt;
&amp;lt;create the interface from the schema&amp;gt;&lt;br/&gt;
&amp;lt;load the field indexes&amp;gt;&lt;br/&gt;
&amp;lt;create a value &quot;prototype&quot; - we set a lot of fields to null&amp;gt;&lt;/p&gt;

&lt;p&gt;Then writing lots of records:&lt;/p&gt;

&lt;p&gt;&amp;lt;create a generic value from the writer schema&amp;gt;&lt;br/&gt;
&amp;lt;copy the value prototype, ie: avro_value_copy_fast&amp;gt;&lt;br/&gt;
&amp;lt;fill in the values which we need to set&amp;gt;&lt;br/&gt;
&amp;lt;append the value to the writer&amp;gt;&lt;br/&gt;
&amp;lt;decref&amp;gt;&lt;/p&gt;

&lt;p&gt;What we would like to see is some more in depth documentation as we currently use the tests as our reference &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13455304" author="dcreager" created="Thu, 13 Sep 2012 21:17:41 +0000"  >&lt;p&gt;Keeping the existing approach for the efficiency reasons described above.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12529939" name="AVRO-1101.patch" size="19153" author="mpugachev" created="Mon, 28 May 2012 09:21:26 +0000"/>
                            <attachment id="12529068" name="example3.c" size="2425" author="mpugachev" created="Thu, 24 May 2012 14:21:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 7 Jun 2012 17:48:14 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253652</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 19 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0e4d3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>80469</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>


<item>
            <title>[AVRO-1102] avro-c: memory leak in avro_string() function</title>
                <link>https://issues.apache.org/jira/browse/AVRO-1102</link>
                <project id="12310911" key="AVRO">Apache Avro</project>
                    <description>&lt;p&gt;Memory leak in error checking code. Patch for this issue is in attached file.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12558045">AVRO-1102</key>
            <summary>avro-c: memory leak in avro_string() function</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mpugachev">Pugachev Maxim</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 May 2012 06:43:11 +0000</created>
                <updated>Mon, 11 Jun 2012 20:01:34 +0000</updated>
                            <resolved>Thu, 7 Jun 2012 17:41:19 +0000</resolved>
                                    <version>1.6.3</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.7.0</fixVersion>
                                    <component>c</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                <comments>
                            <comment id="13283163" author="mpugachev" created="Fri, 25 May 2012 06:44:09 +0000"  >&lt;p&gt;Patch.&lt;/p&gt;</comment>
                            <comment id="13291152" author="dcreager" created="Thu, 7 Jun 2012 17:41:19 +0000"  >&lt;p&gt;Committed to SVN trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12529677" name="AVRO-1102.patch" size="508" author="mpugachev" created="Fri, 25 May 2012 06:44:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Thu, 7 Jun 2012 17:41:19 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253653</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0e4db:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>80470</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>


<item>
            <title>[AVRO-1103] New AvroDeserializer should Locate Appropriate Classloader</title>
                <link>https://issues.apache.org/jira/browse/AVRO-1103</link>
                <project id="12310911" key="AVRO">Apache Avro</project>
                    <description>&lt;p&gt;Continuing on from &lt;a href=&quot;https://issues.apache.org/jira/browse/AVRO-873&quot; title=&quot;SpecificDatumReader should allow users to specify the ClassLoader used.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AVRO-873&quot;&gt;&lt;del&gt;AVRO-873&lt;/del&gt;&lt;/a&gt; I believe some more work needs to be done to get the MapReduce 2 APIs in Avro 1.7 working with Hadoop 0.23. Since it revolves around classloaders it is complex to present a unit test which fails so I will explain the problem:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;By default SpecificDatumReader will use the classloader it was loaded from to find a Specific class to deserialize into.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In earlier versions of Hadoop e.g. 0.20.2 Avro was not included so typically you would bundle Avro into your job jar along with the Specific classes so they would be on the same classpath.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;However later versions of Hadoop such as 0.23 ship with Avro. Thus you find that the SpecificData.class.getClassloader() is typically a parent loader which just contains Hadoop components.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Thus when SpecificData goes to construct a Specific class from the schema it cannot locate it and silently defaults to creating a GenericData.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/AVRO-873&quot; title=&quot;SpecificDatumReader should allow users to specify the ClassLoader used.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AVRO-873&quot;&gt;&lt;del&gt;AVRO-873&lt;/del&gt;&lt;/a&gt; an additional constructor was added to SpecificData to force it to use a different classloader. Thus to extend this fix to the new MR2 APIs:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;AvroDeserializer could attempt to instantiate the class using Class.forName() and from this get the appropriate Classloader and pass this into the constructor of SpecificDatumReader.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Line 2771 of SpecificData.java is:&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;Class c = SpecificData.get().getClass(schema);&lt;/p&gt;&lt;/blockquote&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;This would need to be changed to:&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;Class c = this.getClass(schema);&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have raised this in the mail groups here: &lt;a href=&quot;http://search-hadoop.com/m/wVUf1aLCwd/classloader/v=threaded&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://search-hadoop.com/m/wVUf1aLCwd/classloader/v=threaded&lt;/a&gt; so apologies if this is already being thought about.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Hadoop 0.23.1 with Avro jars replaced by 1.7 jars&lt;br/&gt;
Specific data classes assembled into JAR with mapper/reducer&lt;/p&gt;</environment>
        <key id="12558254">AVRO-1103</key>
            <summary>New AvroDeserializer should Locate Appropriate Classloader</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype">Improvement</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cutting">Doug Cutting</assignee>
                                    <reporter username="jacobmetcalf">Jacob Metcalf</reporter>
                        <labels>
                    </labels>
                <created>Sat, 26 May 2012 18:12:20 +0000</created>
                <updated>Fri, 1 Feb 2013 16:28:54 +0000</updated>
                            <resolved>Wed, 1 Aug 2012 21:15:19 +0000</resolved>
                                    <version>1.7.0</version>
                                    <fixVersion>1.7.2</fixVersion>
                                    <component>java</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                <comments>
                            <comment id="13295848" author="cutting" created="Fri, 15 Jun 2012 18:53:47 +0000"  >&lt;p&gt;Here&apos;s a patch that implements what I believe you are suggesting.  Existing tests pass.&lt;/p&gt;

&lt;p&gt;Can you please verify whether this works for you?  Thanks!&lt;/p&gt;</comment>
                            <comment id="13295950" author="cutting" created="Fri, 15 Jun 2012 22:07:24 +0000"  >&lt;p&gt;Improved patch that gets classloader from configuration like other serializers.&lt;/p&gt;</comment>
                            <comment id="13295988" author="cutting" created="Fri, 15 Jun 2012 23:02:40 +0000"  >&lt;p&gt;New version of patch that adds a test.&lt;/p&gt;

&lt;p&gt;I&apos;ll commit this soon unless there are objections.&lt;/p&gt;</comment>
                            <comment id="13296148" author="jacobmetcalf" created="Sat, 16 Jun 2012 13:25:13 +0000"  >&lt;p&gt;Doug, thanks for doing this. Am based in the UK so tested this morning. There were some issues that meant I had to extend the patch a bit and I am still left with two problems that I have not solved.&lt;/p&gt;

&lt;p&gt;The first task I had was to make the changes to compile avro-mapred against Hadoop 2. These are relatively easy as the incompatiblity is confined to TaskAttemptContext &amp;amp; SequenceFileBase. &lt;/p&gt;

&lt;p&gt;Secondly your patched AvroSerialization whilst it uses the config object is still trying to use the parent ClassLoader so cannot find my Avro class. I have included my attempt to address this in the patch. Basically I locate the classloader using: &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Class.forName( schema.getFullName()).getClassLoader() &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;With some additional logic to support UNIONs. I am sure it could be a lot more elegant/efficient but it worked.&lt;/p&gt;

&lt;p&gt;This got me a long way forward. Now Hadoop 2 / Avro 1.7 are able to deserialize my Avro Specific classes in the shuffle. However I am still left with two corollary classloader problems:&lt;/p&gt;

&lt;p&gt;2) Doing a deepCopy via &amp;lt;MyClass&amp;gt;.newBuilder( &amp;lt;myObject&amp;gt; ).build(). Here the problem boils down to another use of SpecificData.get() this time in SpecificRecordBuilderBase.java: &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;  protected SpecificRecordBuilderBase(Schema schema) {{&lt;br/&gt;
    super(schema, SpecificData.get());&lt;br/&gt;
 }}&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;3) Using AvroKeyValueInputFormat to deserialize from a file. This is another case of needing to pass a SpecificData object to a reader, this time in AvroRecordReaderBase.java:90:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;     // Wrap the seekable input stream in an Avro DataFileReader.&lt;br/&gt;
     mAvroFileReader = createAvroFileReader(seekableFileInput,&lt;br/&gt;
         new ReflectDatumReader&amp;lt;T&amp;gt;(mReaderSchema));&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;In terms of taking this forward - Its a big ask but it would help me immensely if a version of avro-mapred 1.7 for Hadoop 2 could be made available. For example the MRUnit team have come up with a way of distributing both Hadoop 1 and 2 versions with users selecting using a &amp;lt;classifier&amp;gt;hadoop2&amp;lt;/classifier&amp;gt;. Then, if you are happy with my fix for the first problem, I can help come up with solutions/test fixes for problems 2 &amp;amp; 3. Happy to raise additional JIRAs for all these points.&lt;/p&gt;
</comment>
                            <comment id="13396209" author="cutting" created="Mon, 18 Jun 2012 20:13:31 +0000"  >&lt;p&gt;(I&apos;m mostly offline this week, so will be slow to respond.)&lt;/p&gt;

&lt;p&gt;&amp;gt; your patched AvroSerialization whilst it uses the config object is still&lt;br/&gt;
&amp;gt; trying to use the parent ClassLoader so cannot find my Avro class&lt;/p&gt;

&lt;p&gt;I&apos;m confused by this.  Using the classloader from the configuration is what Hadoop does for Writables, no?  If the configuration has the wrong classloader then we might set that to be the same as what Class.forName() uses.  Calling Class.forName&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.getClassloader() seems circular to me.&lt;/p&gt;

&lt;p&gt;&amp;gt; it would help me immensely if a version of avro-mapred 1.7 for Hadoop 2 could be made available&lt;/p&gt;

&lt;p&gt;Are code changes required or simply changes in pom.xml dependencies?&lt;/p&gt;
</comment>
                            <comment id="13396264" author="jacobmetcalf" created="Mon, 18 Jun 2012 21:19:15 +0000"  >&lt;p&gt;I have not yet delved far enough into the innards of Hadoop to understand why Configuration.getClassloader() does not work for me. I can see it does the following:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt; private ClassLoader classLoader;&lt;br/&gt;
 {{&lt;br/&gt;
    classLoader = Thread.currentThread().getContextClassLoader();&lt;br/&gt;
    if (classLoader == null) {{&lt;br/&gt;
       classLoader = Configuration.class.getClassLoader();&lt;br/&gt;
     }}&lt;br/&gt;
  }}&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;When I debug 0.23.1 in standalone mode I can see that the config classLoader does not reference the jar containing my Avro specific classes from the /lib directory of my job jar. I agree calling Class.forName(...).getClassLoader() is a sledge hammer to crack a nut. I can debug a bit more this week to try and work out why.&lt;/p&gt;


&lt;p&gt;For Hadoop 2 its both pom and code changes. But the code changes were relatively easy as the difference in the versions seemed to be confined to TaskAttemptContext &amp;amp; SequenceFileBase.&lt;/p&gt;
</comment>
                            <comment id="13405071" author="jacobmetcalf" created="Mon, 2 Jul 2012 13:50:57 +0000"  >&lt;p&gt;If you are okay with it I am going to close this issue. I have had to switch my environment to Hadoop CDH4 under which I cannot reproduce the problem (reasons below). I have also attached my latest patch for building Avro 1.7 with CDH4 in case its of any use when you come to supporting Hadoop 2.&lt;/p&gt;

&lt;p&gt;In terms of why I cannot reproduce it on CDH4. I was getting this problem because the core Avro jar and the jar with my Avro specific classes in were being loaded by different class loaders. This was because I was distributing my Avro Specific classes via the /lib mechanism - option 2 on &lt;a href=&quot;http://www.cloudera.com/blog/2011/01/how-to-include-third-party-libraries-in-your-map-reduce-job/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://www.cloudera.com/blog/2011/01/how-to-include-third-party-libraries-in-your-map-reduce-job/&lt;/a&gt;. However as this page alludes to Cloudera are phasing this option out so now I have now switched to option 3 - just dropping all my jars directly into the lib directory on all nodes. Hence they all get loaded by the same classloader and everything works.&lt;/p&gt;</comment>
                            <comment id="13423101" author="stevenwillis" created="Thu, 26 Jul 2012 14:19:29 +0000"  >&lt;p&gt;I just came from &lt;a href=&quot;https://issues.apache.org/jira/browse/AVRO-1123&quot; title=&quot;SpecificData is not using the custom ClassLoader in newRecord&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AVRO-1123&quot;&gt;&lt;del&gt;AVRO-1123&lt;/del&gt;&lt;/a&gt; which addresses a subset of this issue. I&apos;m still having problems with avro when my generated class can only be found via an alternate ClassLoader. This patch should fix my issues. I&apos;d appreciate it if this jira isn&apos;t closed, but the patch applied.&lt;/p&gt;

&lt;p&gt;A simple way to test the issue I&apos;m having is to put a generated avro class in a jar along with another class which tries to read from an avro file containing records of your class, then run:&lt;/p&gt;

&lt;p&gt;$ hadoop jar myjar.jar MainClass input_file.avro&lt;/p&gt;

&lt;p&gt;You&apos;ll get a generic back from the reader instead of your generated class because RunJar uses an alternate ClassLoader to run the jar. However if you run:&lt;/p&gt;

&lt;p&gt;$ HADOOP_CLASSPATH=myjar.jar hadoop jar myjar.jar MainClass input_file.avro&lt;/p&gt;

&lt;p&gt;Then you&apos;ll get what you expect because now the jar containing the avro class is also accessible via the standard ClassLoader since it&apos;s now on the classpath.&lt;/p&gt;</comment>
                            <comment id="13423480" author="cutting" created="Thu, 26 Jul 2012 21:20:04 +0000"  >&lt;p&gt;I&apos;ll commit this soon unless someone objects.&lt;/p&gt;</comment>
                            <comment id="13426903" author="cutting" created="Wed, 1 Aug 2012 21:15:19 +0000"  >&lt;p&gt;I committed this.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12596136">AVRO-1123</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12630397">AVRO-1240</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12518397">AVRO-873</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12532297" name="AVRO-1103-for 0.23.1.patch" size="22353" author="jacobmetcalf" created="Sat, 16 Jun 2012 12:43:44 +0000"/>
                            <attachment id="12532262" name="AVRO-1103.patch" size="11026" author="cutting" created="Fri, 15 Jun 2012 23:02:40 +0000"/>
                            <attachment id="12532245" name="AVRO-1103.patch" size="8677" author="cutting" created="Fri, 15 Jun 2012 22:07:24 +0000"/>
                            <attachment id="12532225" name="AVRO-1103.patch" size="7359" author="cutting" created="Fri, 15 Jun 2012 18:53:47 +0000"/>
                            <attachment id="12534276" name="AvroCDH4.patch" size="33768" author="jacobmetcalf" created="Mon, 2 Jul 2012 13:32:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fri, 15 Jun 2012 18:53:47 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253654</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0e4dj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>80471</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310230" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Tags</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>classloader</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                    </customfields>
    </item>
</channel>
</rss>
